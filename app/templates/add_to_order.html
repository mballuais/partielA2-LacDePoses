{% extends "base.html" %}

{% block title %}Ajouter à la commande{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <h2>Commande de {{ order.customer_name }}</h2>
        <p><strong>Prix total actuel :</strong> <span class="badge bg-primary fs-6">{{ "%.2f"|format(order.total_price) }} €</span></p>
        
        {% if materials %}
        <form method="POST" class="mb-4">
            <div class="row">
                <div class="col-md-6">
                    <label for="material_id" class="form-label">Matériel à louer</label>
                    <select class="form-control" id="material_id" name="material_id" required>
                        <option value="">Choisir un matériel...</option>
                        {% for material in materials %}
                        <option value="{{ material.id }}">
                            {{ material.name }} - {{ material.available_quantity }} dispo - {{ "%.2f"|format(material.rental_price) }}€
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="quantity" class="form-label">Quantité</label>
                    <input type="number" class="form-control" id="quantity" name="quantity" min="1" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-success d-block">Ajouter</button>
                </div>
            </div>
        </form>
        {% else %}
        <div class="alert alert-warning">
            Aucun matériel disponible pour cette commande.
        </div>
        {% endif %}
        
        <div class="d-grid gap-2 d-md-flex">
            <a href="{{ url_for('main.index') }}" class="btn btn-primary">Terminer Commande</a>
        </div>
    </div>
    
    <div class="col-md-4">
        <h3>Détail de la commande</h3>
        {% if order.items %}
        <div class="card">
            <div class="card-body">
                {% for item in order.items %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <span>{{ item.quantity }}x {{ item.material.name }}</span><br>
                        <small class="text-muted">{{ "%.2f"|format(item.unit_price) }}€/unité</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="me-2"><strong>{{ "%.2f"|format(item.quantity * item.unit_price) }}€</strong></span>
                        <a href="{{ url_for('main.remove_item', item_id=item.id) }}" 
                           class="btn btn-sm btn-outline-danger"
                           onclick="return confirm('Supprimer {{ item.quantity }}x {{ item.material.name }} ?')"
                           title="Supprimer cet item">
                           ✕
                        </a>
                    </div>
                </div>
                {% if not loop.last %}<hr class="my-2">{% endif %}
                {% endfor %}
                <hr>
                <div class="d-flex justify-content-between fw-bold">
                    <span>Total :</span>
                    <span>{{ "%.2f"|format(order.total_price) }}€</span>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            Aucun matériel ajouté à cette commande.
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}